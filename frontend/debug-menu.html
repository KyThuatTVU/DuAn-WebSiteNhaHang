<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Menu API</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8">üîß Debug Menu API</h1>
        
        <!-- Status Panel -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">API Status</h2>
            <div id="apiStatus" class="space-y-2">
                <div class="flex items-center">
                    <div id="connectionStatus" class="w-3 h-3 rounded-full bg-gray-400 mr-3"></div>
                    <span id="connectionText">Checking connection...</span>
                </div>
            </div>
        </div>
        
        <!-- Search Test -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4">Search Test</h2>
            <div class="flex space-x-4 mb-4">
                <input id="searchInput" type="text" placeholder="Nh·∫≠p t·ª´ kh√≥a t√¨m ki·∫øm..." 
                       class="flex-1 px-4 py-2 border border-gray-300 rounded-lg">
                <button onclick="testSearch()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg">
                    <i class="fas fa-search mr-2"></i>T√¨m ki·∫øm
                </button>
            </div>
            <div id="searchResults" class="space-y-2">
                <!-- Search results will appear here -->
            </div>
        </div>
        
        <!-- Menu Items Display -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4">Menu Items</h2>
            <div id="menuItems" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Menu items will appear here -->
            </div>
        </div>
        
        <!-- Console Log -->
        <div class="bg-gray-900 text-green-400 rounded-lg p-4 mt-8">
            <h3 class="text-lg font-semibold mb-2">Console Log</h3>
            <div id="consoleLog" class="font-mono text-sm max-h-64 overflow-y-auto">
                <!-- Console messages will appear here -->
            </div>
        </div>
    </div>

    <!-- Include API Service -->
    <script src="js/menu-api.js"></script>
    
    <script>
        // Initialize API service
        const apiService = new MenuAPIService();
        let menuData = [];

        // Placeholder image function
        function getPlaceholderImage() {
            return 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y3ZjdmNyIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwsIHNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Iw6xuaCDhuqNuaDwvdGV4dD4KICA8L3N2Zz4K';
        }
        
        // Console logging override
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToConsole(type, message) {
            const consoleLog = document.getElementById('consoleLog');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'text-red-400' : type === 'warn' ? 'text-yellow-400' : 'text-green-400';
            
            const logEntry = document.createElement('div');
            logEntry.className = `${color} mb-1`;
            logEntry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            
            consoleLog.appendChild(logEntry);
            consoleLog.scrollTop = consoleLog.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToConsole('warn', args.join(' '));
        };
        
        // Test API connection
        async function testConnection() {
            const statusEl = document.getElementById('connectionStatus');
            const textEl = document.getElementById('connectionText');
            
            try {
                console.log('Testing API connection...');
                const isConnected = await apiService.testConnection();
                
                if (isConnected) {
                    statusEl.className = 'w-3 h-3 rounded-full bg-green-500 mr-3';
                    textEl.textContent = 'API Connected ‚úÖ';
                    console.log('API connection successful');
                } else {
                    statusEl.className = 'w-3 h-3 rounded-full bg-red-500 mr-3';
                    textEl.textContent = 'API Disconnected ‚ùå';
                    console.warn('API connection failed');
                }
                
                return isConnected;
            } catch (error) {
                statusEl.className = 'w-3 h-3 rounded-full bg-red-500 mr-3';
                textEl.textContent = `Connection Error: ${error.message}`;
                console.error('Connection test failed:', error);
                return false;
            }
        }
        
        // Test search functionality
        async function testSearch() {
            const searchInput = document.getElementById('searchInput');
            const resultsEl = document.getElementById('searchResults');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) {
                console.warn('Please enter a search term');
                return;
            }
            
            try {
                console.log(`Searching for: "${searchTerm}"`);
                resultsEl.innerHTML = '<div class="text-gray-500">Searching...</div>';
                
                const response = await apiService.searchFoods({ search: searchTerm, limit: 10 });
                
                if (response && response.success && response.data) {
                    console.log(`Found ${response.data.length} results`);
                    
                    if (response.data.length === 0) {
                        resultsEl.innerHTML = '<div class="text-gray-500">No results found</div>';
                    } else {
                        resultsEl.innerHTML = response.data.map(item => `
                            <div class="bg-gray-50 p-3 rounded border">
                                <strong>${item.ten_mon}</strong> - ${item.gia_formatted || item.gia + 'ƒë'}
                                <br><small class="text-gray-600">${item.mo_ta || 'No description'}</small>
                            </div>
                        `).join('');
                    }
                } else {
                    throw new Error('Invalid response format');
                }
                
            } catch (error) {
                console.error('Search failed:', error);
                resultsEl.innerHTML = `<div class="text-red-500">Search failed: ${error.message}</div>`;
            }
        }
        
        // Load all menu items
        async function loadMenuItems() {
            const menuItemsEl = document.getElementById('menuItems');
            
            try {
                console.log('Loading menu items...');
                menuItemsEl.innerHTML = '<div class="col-span-full text-center text-gray-500">Loading...</div>';
                
                const response = await apiService.searchFoods({ limit: 20 });
                
                if (response && response.success && response.data) {
                    menuData = response.data;
                    console.log(`Loaded ${menuData.length} menu items`);
                    
                    if (menuData.length === 0) {
                        menuItemsEl.innerHTML = '<div class="col-span-full text-center text-gray-500">No menu items found</div>';
                    } else {
                        menuItemsEl.innerHTML = menuData.map(item => `
                            <div class="bg-gray-50 p-4 rounded-lg border">
                                <img src="${item.hinh_anh || getPlaceholderImage()}" alt="${item.ten_mon}"
                                     class="w-full h-32 object-cover rounded mb-2"
                                     onerror="this.src=getPlaceholderImage(); this.onerror=null;"
                                     loading="lazy">
                                <h3 class="font-semibold">${item.ten_mon}</h3>
                                <p class="text-primary font-bold">${item.gia_formatted || item.gia + 'ƒë'}</p>
                                <p class="text-sm text-gray-600 mt-1">${item.mo_ta || 'No description'}</p>
                                <div class="mt-2 flex justify-between items-center">
                                    <span class="text-xs px-2 py-1 rounded ${item.so_luong > 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.so_luong_display || (item.so_luong > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng')}
                                    </span>
                                    <span class="text-xs text-gray-500">${item.ten_loai || 'N/A'}</span>
                                </div>
                                <div class="mt-1 text-xs text-blue-600">
                                    Image: ${item.hinh_anh ? '‚úÖ' : '‚ùå'}
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    throw new Error('Invalid response format');
                }
                
            } catch (error) {
                console.error('Failed to load menu items:', error);
                menuItemsEl.innerHTML = `<div class="col-span-full text-center text-red-500">Failed to load: ${error.message}</div>`;
            }
        }
        
        // Initialize on page load
        window.addEventListener('load', async () => {
            console.log('Debug page loaded');
            
            // Test connection
            await testConnection();
            
            // Load menu items
            await loadMenuItems();
        });
        
        // Add search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                testSearch();
            }
        });
    </script>
</body>
</html>
